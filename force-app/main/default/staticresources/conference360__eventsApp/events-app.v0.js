!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.EventsApp=e():t.EventsApp=e()}(this,(function(){return function(t){var e={};function n(o){if(e[o])return e[o].exports;var r=e[o]={i:o,l:!1,exports:{}};return t[o].call(r.exports,r,r.exports,n),r.l=!0,r.exports}return n.m=t,n.c=e,n.d=function(t,e,o){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:o})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)n.d(o,r,function(e){return t[e]}.bind(null,r));return o},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=0)}([function(t,e,n){"use strict";n.r(e),n.d(e,"createInterceptorNextFunction",(function(){return v})),n.d(e,"EventsApp",(function(){return y}));var o=function(){function t(){var t=this;this.createdAt=Date.now(),this.promise=new Promise((function(e,n){t.resolve=function(){for(var n=[],o=0;o<arguments.length;o++)n[o]=arguments[o];e.apply(void 0,n),t.resolvedAt=Date.now()},t.reject=function(){for(var e=[],o=0;o<arguments.length;o++)e[o]=arguments[o];n.apply(void 0,e),t.rejectedAt=Date.now()}}))}return t.prototype.resolve=function(t){},t.prototype.reject=function(t){},t}(),r=function(){return(r=Object.assign||function(t){for(var e,n=1,o=arguments.length;n<o;n++)for(var r in e=arguments[n])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t}).apply(this,arguments)},i=function(t,e,n,o){return new(n||(n=Promise))((function(r,i){function s(t){try{u(o.next(t))}catch(t){i(t)}}function a(t){try{u(o.throw(t))}catch(t){i(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}u((o=o.apply(t,e||[])).next())}))},s=function(t,e){var n,o,r,i,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,o&&(r=2&i[0]?o.return:i[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,i[1])).done)return r;switch(o=0,r&&(i=[2&i[0],r.value]),i[0]){case 0:case 1:r=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,o=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(r=s.trys,(r=r.length>0&&r[r.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!r||i[1]>r[0]&&i[1]<r[3])){s.label=i[1];break}if(6===i[0]&&s.label<r[1]){s.label=r[1],r=i;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(i);break}r[2]&&s.ops.pop(),s.trys.pop();continue}i=e.call(t,s)}catch(t){i=[6,t],o=0}finally{n=r=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}},a="jsonrpc-2.0:res",u=function(){function t(t,e,n,o){this.name=t,this.myWindow=e,this.otherWindow=n,this.options=o,this.invocations={},this.invokeExecutors={},this.notifyExecutors={},this.disposes=[];this.options=r(r({},{origin:"*",invocationReqTimeout:300,invocationTimeout:3e4}),this.options),this.onMessage=this.onMessage.bind(this),this.listenMessage()}return t.prototype.listenMessage=function(){var t=this;this.myWindow.addEventListener("message",this.onMessage,!1),this.disposes.push((function(){t.myWindow.removeEventListener("message",t.onMessage)}))},t.prototype.onMessage=function(t){var e=t.data||{type:"__unknown__",name:"__unknown__"};e.name===this.name&&(e.type===a?this.handleResMessage(e.res):"jsonrpc-2.0:req"===e.type&&this.handleReqMessage(e.name,e.req))},t.prototype.handleResMessage=function(t){if(t&&t.id){var e=t.id,n=t.progress,o=t.result,r=t.error,i=this.invocations[e];i?"processing"!==n?r?i.job.reject(r):i.job.resolve(o):i.processing=!0:console.warn("invalid invocation id or the invocation has timeout already")}else console.warn("invalid jsonrpc response",t)},t.prototype.handleReqMessage=function(t,e){return i(this,void 0,void 0,(function(){var n,o,u,c,p,h,l,f,d=this;return s(this,(function(v){switch(v.label){case 0:return e?(n=e.id,o=e.method,(u=e.params||[])&&!Array.isArray(u)&&(u=[u]),n?[3,1]:((this.notifyExecutors[o]||[]).forEach((function(t){return i(d,void 0,void 0,(function(){var e;return s(this,(function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),[4,t.apply(void 0,u)];case 1:return n.sent(),[3,3];case 2:return e=n.sent(),console.error("Error when execute: "+o,e),[3,3];case 3:return[2]}}))}))})),[3,5])):(console.warn("invalid jsonrpc request",e),[2]);case 1:if(!(c=this.invokeExecutors[o]))return console.warn("there is no executor for "+o),[2];p={jsonrpc:"2.0",id:n},v.label=2;case 2:return v.trys.push([2,4,,5]),this.otherWindow.postMessage({type:a,name:t,res:r(r({},p),{progress:"processing"})},this.options.origin),[4,c.apply(void 0,u)];case 3:return h=v.sent(),this.otherWindow.postMessage({type:a,name:t,res:r(r({},p),{result:h,progress:"done"})},this.options.origin),[3,5];case 4:return l=v.sent(),f={code:1e3,message:l.message},this.otherWindow.postMessage({type:a,name:t,res:r(r({},p),{error:f,progress:"error"})},this.options.origin),[3,5];case 5:return[2]}}))}))},t.prototype.nextId=function(){return this.name+"-"+(new Date).getTime().toString(36)},t.prototype.invoke=function(t,e){return i(this,void 0,void 0,(function(){var n,r,i=this;return s(this,(function(s){return n=this.postReqMessage(t,!1,e),r=new o,this.invocations[n]={job:r,processing:!1},setTimeout((function(){var t=i.invocations[n];if(t)if(t.processing){var e=Math.max(0,i.options.invocationTimeout-i.options.invocationReqTimeout);setTimeout((function(){(t=i.invocations[n])&&(t.job.reject(new Error("timeout")),delete i.invocations[n])}),e)}else t.job.reject(new Error("timeout")),delete i.invocations[n]}),this.options.invocationReqTimeout),[2,r.promise]}))}))},t.prototype.notify=function(t,e){return i(this,void 0,void 0,(function(){return s(this,(function(n){return this.postReqMessage(t,!0,e),[2]}))}))},t.prototype.postReqMessage=function(t,e,n){var o,r={jsonrpc:"2.0",id:o,method:t,params:n};return e||(o=this.nextId(),r.id=o),this.otherWindow.postMessage({type:"jsonrpc-2.0:req",name:this.name,req:r},this.options.origin),o},t.prototype.onInvoke=function(t,e){this.invokeExecutors[t]&&console.warn("override executor for "+t),this.invokeExecutors[t]=e},t.prototype.offInvoke=function(t){delete this.invokeExecutors[t]},t.prototype.onNotify=function(t,e){var n=this.notifyExecutors[t]||[];-1===n.indexOf(e)&&(n.push(e),this.notifyExecutors[t]=n)},t.prototype.offNotify=function(t,e){var n=[];e&&(n=(this.notifyExecutors[t]||[]).filter((function(t){return t!==e})));n.length>0?this.notifyExecutors[t]=n:delete this.notifyExecutors[t]},t.prototype.dispose=function(){this.invocations={},this.invokeExecutors={},this.notifyExecutors={},this.disposes.forEach((function(t){return t()}))},t}(),c=function(t){return!!t},p=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];for(var n,o=t.length,r=-1;++r<o;)if(null!=t[r]){n=t[r];break}return"number"==typeof n||"string"==typeof n&&/^(0|[1-9]\d*)(\.\d+)?$/.test(n)?n+"px":n},h=function(){return(h=Object.assign||function(t){for(var e,n=1,o=arguments.length;n<o;n++)for(var r in e=arguments[n])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t}).apply(this,arguments)},l=function(t,e,n,o){return new(n||(n=Promise))((function(r,i){function s(t){try{u(o.next(t))}catch(t){i(t)}}function a(t){try{u(o.throw(t))}catch(t){i(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}u((o=o.apply(t,e||[])).next())}))},f=function(t,e){var n,o,r,i,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,o&&(r=2&i[0]?o.return:i[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,i[1])).done)return r;switch(o=0,r&&(i=[2&i[0],r.value]),i[0]){case 0:case 1:r=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,o=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(r=s.trys,(r=r.length>0&&r[r.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!r||i[1]>r[0]&&i[1]<r[3])){s.label=i[1];break}if(6===i[0]&&s.label<r[1]){s.label=r[1],r=i;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(i);break}r[2]&&s.ops.pop(),s.trys.pop();continue}i=e.call(t,s)}catch(t){i=[6,t],o=0}finally{n=r=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}},d=function(){for(var t=0,e=0,n=arguments.length;e<n;e++)t+=arguments[e].length;var o=Array(t),r=0;for(e=0;e<n;e++)for(var i=arguments[e],s=0,a=i.length;s<a;s++,r++)o[r]=i[s];return o},v=function(){var t=new o;return{next:Object.assign((function(e){t.resolve({params:e})}),{preventDefault:function(){t.resolve({preventDefault:!0})}}),deferred:t}},y=function(){function t(e){var n,o={version:void 0,instanceUrl:"https://events.blackthorn.io",listeners:[],interceptors:[]};this.options=h(h(h({},o),e),{width:p(e.width,"100%"),height:p(e.height,"500px"),maxwidth:p(e.maxwidth,"none"),maxheight:p(e.maxheight,"none")}),this.requireOptions([["orgId","vanityUrl"]]),this.options.instanceUrl=this.options.instanceUrl.replace(/\/$/,""),this.sessionId=t.getNextSessionId(),this.className=["bt-eventsapp",(n=this.label||"",n.toLowerCase().replace(/[^\w ]+/g,"").replace(/ +/g,"-")),this.sessionId].filter(c).join("-"),this.updateStyle()}return t.getNextSessionId=function(){return""+(Date.now()+t.nextSessionId++)},Object.defineProperty(t.prototype,"label",{get:function(){return this.options.label},enumerable:!0,configurable:!0}),t.prototype.requireOptions=function(t){var e=this;t.forEach((function(t){if(Array.isArray(t)){if(!t.some((function(t){return!!e.options[t]})))throw new Error("EventsApp: required option missing, one of ["+t.join(", ")+"] is required")}else if(!e.options[t])throw new Error("EventsApp: required option missing, "+t+" is required")}))},t.prototype.mount=function(t){var e;if(!(e="string"==typeof t?document.querySelector(t):t))throw new Error("Mount point doesn't exist: "+t);return this.loadAndAttachEvent(e)},t.prototype.updateStyle=function(){this.styleElement||(this.styleElement=function(t){var e=document.createElement("style");return t&&(e.innerHTML=t),document.head.appendChild(e),e}());var t=this.options,e=t.width,n=t.height,o=t.maxwidth,r=t.maxheight,i="."+this.className+" { width: "+e+"; height: "+n+"; max-width: "+o+"; max-height: "+r+" }\n."+this.className+" iframe { border: none; width: 100%; height: 100% }";!function(t,e){t.innerHTML=e}(this.styleElement,i)},t.prototype.destroyStyle=function(){this.styleElement&&(this.styleElement.remove(),this.styleElement=void 0)},t.prototype.setWrapperClass=function(t){if(this.wrapper){var e=Array.isArray(t)?t:[t];this.wrapper.className=d([this.className],e).filter(c).join(" ")}},t.prototype.setScrolling=function(t){this.iframe&&(this.iframe.scrolling=this.coerceScrolling(t))},t.prototype.setSize=function(t){this.options.height=p(t.height,this.options.height),this.options.width=p(t.width,this.options.width),this.options.maxheight=p(t.maxheight,this.options.maxheight),this.options.maxwidth=p(t.maxwidth,this.options.maxwidth),this.updateStyle()},t.prototype.setRoute=function(t){return this.guardCall("setRoute")?(t=h({replaceUrl:!0},t),this.rpc.invoke("SET_ROUTE",t)):Promise.resolve(!1)},t.prototype.getRoute=function(){return this.guardCall("getRoute")?this.rpc.invoke("GET_ROUTE"):Promise.resolve(null)},t.prototype.sendMessage=function(t){return this.guardCall("sendMessage")?this.rpc.invoke("SEND_MESSAGE",t):Promise.resolve()},t.prototype.destroy=function(){this.rpc&&(this.rpc.dispose(),this.rpc=void 0),this.wrapper&&(this.wrapper.remove(),this.wrapper=void 0,this.iframe=void 0),this.destroyStyle()},t.prototype.setupListenersAndInterceptors=function(){var t=this,e=this.options,n=e.listeners,o=e.interceptors;n.forEach((function(e){t.rpc.onNotify(e.event,(function(t){return e.handler(t)}))})),o.forEach((function(e){t.rpc.onInvoke(e.event,(function(n){return l(t,void 0,void 0,(function(){var t,o,r;return f(this,(function(i){return t=v(),o=t.deferred,r=t.next,e.handler(n,r),[2,o.promise]}))}))}))}))},t.prototype.updateConfig=function(){return l(this,void 0,void 0,(function(){var t,e,n,o,r;return f(this,(function(i){switch(i.label){case 0:return t=this.options,e=t.interceptors,n=t.listeners,o=t.version,r=t.scrolling,[4,this.rpc.invoke("UPDATE_CONFIG",{version:o,scrolling:r,listeners:n.map((function(t){return{event:t.event}})),interceptors:e.map((function(t){return{event:t.event}}))})];case 1:return i.sent(),[2]}}))}))},t.prototype.parsePath=function(t){var e=t.split("?"),n=e[0],o=e[1];return{path:n.replace(/^\/+/,"").replace(/\/+$/,""),query:o}},t.prototype.coerceScrolling=function(t){switch(t){case"yes":case"no":case"auto":return t}},t.prototype.createIframeTemplate=function(){var t=p(this.options.height,"100vh"),e=p(this.options.width,"100vw"),n=this.options.instanceUrl||"https://events.blackthorn.io",o=this.parsePath(this.options.path||""),r=o.path,i=o.query,s="_sid="+this.sessionId+"&_embed=true&_vh="+encodeURI(t)+"&_vw="+encodeURI(e);return this.options.ssoCode&&(s="_sso="+this.options.ssoCode+"&"+s),i&&(s=i+"&"+s),'<iframe src="'+(this.options.orgId?[n,this.options.orgId,r].filter((function(t){return!!t})).join("/")+"?"+s:[this.options.vanityUrl,r].filter((function(t){return!!t})).join("/")+"?"+s)+'"></iframe>'},t.prototype.loadAndAttachEvent=function(t){return l(this,void 0,void 0,(function(){var e,n,o,r,i,s,a=this;return f(this,(function(c){return e=this.createIframeTemplate(),(n=document.createElement("div")).innerHTML=e,t.appendChild(n),this.wrapper=n,this.setWrapperClass(this.options.wrapperClass),o=["bt-events",this.sessionId].join(":"),r=n.firstChild,(i=this.coerceScrolling(this.options.scrolling))&&(r.scrolling=i),(s=new u(o,window,r.contentWindow,{invocationReqTimeout:3e4,invocationTimeout:6e4})).onNotify("APP_BOOTSTRAPPED",(function(){a.updateConfig()})),this.rpc=s,this.iframe=r,this.setupListenersAndInterceptors(),[2]}))}))},t.prototype.guardCall=function(t){return!!this.rpc||(console.warn("#"+t+": app is not ready"),!1)},t.nextSessionId=1,t}()}]).EventsApp}));